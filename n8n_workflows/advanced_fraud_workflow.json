{
  "name": "AI Ops Wizard - Fraud Analyze (advanced)",
  "settings": {},
  "active": true,
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "fraud-webhook",
        "responseMode": "lastNode",
        "responseData": "allEntries"
      },
      "name": "Webhook In",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "values": { "string": [ { "name": "id", "value": "={{ $json.id || 'evt-' + $randomString(8) }}" } ] },
        "options": {}
      },
      "name": "Set Meta",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [440, 300]
    },
    {
      "parameters": { "mode": "sequential", "limit": 5 },
      "name": "Rate Limit (sequential)",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "={{ $json[\"env\"]?.BACKEND_URL || 'http://api:8000/analyze' }}",
        "jsonParameters": true,
        "bodyParametersJson": "={{ JSON.stringify({ amount: ($json.payload?.amount || $json.amount || 0), currency: ($json.payload?.currency || 'USD'), merchant: ($json.payload?.merchant || $json.merchant || null), timestamp: ($json.payload?.timestamp || new Date().toISOString()), ip_address: ($json.payload?.ip_address || $json.payload?.ip || $json.ip || null), customer_id: ($json.payload?.customer_id || $json.customer_id || null) }) }}",
        "options": { "throwHttpErrors": false }
      },
      "name": "Call AI-Core (/analyze)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [920, 300]
    },
    {
      "parameters": {
        "rules": [
          { "operation": "contains", "value1": "={{ $json[\"body\"]?.data?.suggested_action || '' }}", "value2": "BLOCK" }
        ],
        "combineOperation": "any"
      },
      "name": "Is BLOCK?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1160, 220]
    },
    {
      "parameters": {
        "rules": [
          { "operation": "contains", "value1": "={{ $json[\"body\"]?.data?.suggested_action || '' }}", "value2": "REVIEW" }
        ],
        "combineOperation": "any"
      },
      "name": "Is REVIEW?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1160, 380]
    },
    {
      "parameters": {
        "authentication": "none",
        "requestMethod": "POST",
        "url": "https://ops.example.internal/fraud/notify",
        "jsonParameters": true,
        "bodyParametersJson": "={{ JSON.stringify({ external_id: $json[\"body\"]?.data?.id || $json.id, action: $json[\"body\"]?.data?.suggested_action, score: $json[\"body\"]?.data?.score, first_step_title: $json[\"body\"]?.data?.wizard_steps?.[0]?.title || '', reasoning: $json[\"body\"]?.data?.reasoning, meta: $json[\"body\"]?.meta || {} }) }}",
        "options": { "throwHttpErrors": false }
      },
      "name": "Notify Ops Webhook",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1400, 360]
    },
    {
      "parameters": {
        "authentication": "none",
        "requestMethod": "POST",
        "url": "https://crm.example.internal/api/cases",
        "jsonParameters": true,
        "bodyParametersJson": "={{ JSON.stringify({ external_id: $json[\"body\"]?.data?.id || $json.id, reason: $json[\"body\"]?.data?.reasoning || 'Manual review required', meta: $json[\"body\"] }) }}",
        "options": { "throwHttpErrors": false }
      },
      "name": "Create CRM Case (placeholder)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [1400, 460]
    },
    {
      "parameters": {
        "value1": "={{ $json[\"body\"]?.error?.code || $json[\"body\"]?.error?.message || '' }}",
        "operation": "isNotEmpty",
        "value2": ""
      },
      "name": "Is Error?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1160, 560]
    },
    {
      "parameters": {
        "mode": "delay",
        "delayFor": 1,
        "delayUnit": "minutes"
      },
      "name": "Wait / Retry Delay",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [1400, 560]
    },
    {
      "parameters": {
        "operation": "response",
        "responseCode": 200,
        "responseBody": "={{ { status: $json.body?.error ? 'error' : 'ok', id: $json.body?.data?.id || $json.id, action: $json.body?.data?.suggested_action, error: $json.body?.error || null } }}"
      },
      "name": "Return Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1640, 300]
    }
  ],
  "connections": {
    "Webhook In": { "main": [[{ "node": "Set Meta", "type": "main", "index": 0 }]] },
    "Set Meta": { "main": [[{ "node": "Rate Limit (sequential)", "type": "main", "index": 0 }]] },
    "Rate Limit (sequential)": { "main": [[{ "node": "Call AI-Core (/analyze)", "type": "main", "index": 0 }]] },
    "Call AI-Core (/analyze)": {
      "main": [
        [{ "node": "Is HOLD?", "type": "main", "index": 0 }],
        [{ "node": "Is MANUAL?", "type": "main", "index": 0 }],
        [{ "node": "Is Error?", "type": "main", "index": 0 }],
        [{ "node": "Return Response", "type": "main", "index": 0 }]
      ],
      "error": [
        [{ "node": "Is Error?", "type": "main", "index": 0 }]
      ]
    },
    "Is HOLD?": { "main": [[{ "node": "Return Response", "type": "main", "index": 0 }]] },
    "Is MANUAL?": { "main": [[{ "node": "Notify Slack", "type": "main", "index": 0 }], [{ "node": "Create CRM Case (placeholder)", "type": "main", "index": 0 }], [{ "node": "Return Response", "type": "main", "index": 0 }]] },
    "Is Error?": { "main": [[{ "node": "Wait / Retry Delay", "type": "main", "index": 0 }]] },
    "Wait / Retry Delay": { "main": [[{ "node": "Call AI-Core (/analyze)", "type": "main", "index": 0 }]] },
    "Return Response": { "main": [] }
  }
}
